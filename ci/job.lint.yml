parameters:
  platforms:
    - name: Linux
      vmImage: ubuntu-16.04
      activate: source activate
  pythons:
    - name: ThreeSeven
      spec: '>=3.8,<3.9.0a0'
      lab: '>=2,<3.0.0a0'
      nodejs: '>=12,<13.0.0a0'
  env_update: conda env update -n jupyterlab-lsp --file env-test.yml --quiet
  env_lint: conda env update -n jupyterlab-lsp --file requirements/lint.yml --quiet

jobs:
  - ${{ each platform in parameters.platforms }}:
      - ${{ each python in parameters.pythons}}:
          - job: Lint
            runs-on: ${{ platform.vmImage }}
            steps:
              - name: Set up Python and conda
                uses: s-weigand/setup-conda@v1
                with:
                  update-conda: false
                  python-version: ${{ python.spec }}
                  conda-channels: anaconda, conda-forge

              - name: generate env with lab and node version
                run: ${{ platform.activate }} && cd ci && python env_template.py "${{ python.lab }}" "{{ python.nodejs }}"

              - run: ${{ parameters.env_update }} || ${{ parameters.env_update }} || ${{ parameters.env_update }}
                name: testing dependencies

              - run: ${{ parameters.env_lint }} || ${{ parameters.env_lint }} || ${{ parameters.env_lint }}
                name: linting dependencies

              - run: ${{ platform.activate }} jupyterlab-lsp && python scripts/integrity.py
                name: check integrity of package versions

              - run: ${{ platform.activate }} jupyterlab-lsp && jlpm || jlpm || jlpm
                name: install npm dependencies

              - run: ${{ platform.activate }} jupyterlab-lsp && python scripts/lint.py
                name: lint backend

              - run: ${{ platform.activate }} jupyterlab-lsp && jlpm build:schema
                name: build schema so linting can complete

              - run: ${{ platform.activate }} jupyterlab-lsp && jlpm lint:check
                name: lint frontend
